language: php

php:
  - 5.3
  - 5.5
  # @TODO test 5.6 when we move to 5.5
  #- 5.6

cache:
  bundler: true
  apt: true

env:
  global:
  - COMPOSER_BIN_DIR=$TRAVIS_BUILD_DIR/build/bin
  - BEHAT_PARAMS='{"extensions":{"Behat\\MinkExtension":{"base_url":"http://localhost/"}}}'
  - ARTIFACTS_BUCKET=travis-ci-fails
  - secure: xMmMEQUhk8ugxJkUZnoHbQe9OXmRV4I80Uq/HU296hXB+hRmEFaH3jpE6A8Hm4k9OIaFJD2h7Ti16d93sQ7q9evUnx4JDBj5oi/8G3kCqqTHOKLiZId0nKZ+qLIUCdmXT2CASxMrYSgtIWWuJ4gkfFLfmoFvqiT/bMs/F7sDEoaZPGAjvyjMRBzysYm0utyhkEzdgW6ZwBRZvtLIpqnD9gNLJ1TaD7erisspKJA7PYHvF0L1GSqSC7EX2yNAZzZpU7BuuHxcEDGvYOK8nRZidubTQmkYhRt1nzTvCWLLwezdgpHlGRRABczWVIITYXlmQeXTji+mVd1p2b4Tk2GLJiDpOIszpxltNs65JMWH98uytfakN7wcA4dhVstiaXGJlnM6AxKWONql6IMTXaPrfz2X2Dwh+rfj9OkVjTzPAhVJRfQm4nq2XiyBtpTdYBL0Xm7gahWP1tIBMlKlSO5pyBVN2+AeBEdz69Nv21rleE/OZtve8r2GlEAT/xcXAQa13gAvquS8BfKztXQ1S/2H7Ev/CdIQ6UbxCKnjDwanEyOuJ+n0ZD83lfuVt5Rfg/7oip+I6BbGA8PFd5zWuluhKBsRDuLL+3MCnIZYGQK2QCGkpbL1U6A/p2wORoxBWuh7LrrgD5nSfu5blAFVtC7ThIAJFIZdXEkBZCNURy/f6zE=
  - secure: glt7dcWQNJqsTcFTK+/mbmjtptK836RWw/xDYCFtbNI/Z17vNpppzmch6goQrc1XUC48hGxOoHh+MERIusiGCEQzJR1qO14sZrsj0HSMt7sWlwBBQU6nTH1rm8GOgmqElA26ao5b26bm63izhznN3oQsclmvT1o0J/+HpVHXu0XMiKD0e3UG2DCkna5SvZbwQophcy64of147R6HVSaWwypTFlcJMEva3jHDPyKiKH0as3S80HGMaFCpfJBV9FjepzqjU81AEsoVmHThlDUt0hG0QGmewQYy7sZKhzQf/oz8Gf7aCE3DwFzcoRfd2QzQ1/AuFzIIUrkEOjYrqmgEVberlyeTCx7y/P40mr9yV1J/3VGtIXIxyac3SqiNeUmfFJAM6MMPfrdumcFlf0BdRSieoVuASTs7Q8Q6y1jFE/P50kKfpR8E873nJ4OrliUQ1FFusHfa8Siv2vsAucBIkzdetn9TVHzjmtWRkHg07KS+IVSt6QztPrTkx6dPqL+i9RFj+H1p+72lZXyZRYusAx8kk9FfnYICh03qsmM1qa/jyqiYv+GxOXcpXZONcKiXM/DDaLNey7nlOW9A2Hrx1zVPFIIdyJB7RMqkogJH4UBRfKnXW7QptxoSPP9F37gJ+r3Jh7hADRYralfA1nMbaqCODzxIE4oUTA0WiGboIw0=

addons:
  artifacts:
    bucket: travis-ci-fails
    paths:
    - $TRAVIS_BUILD_DIR/build/phing/screenshot-fail.png
    debug: true

notifications:
  email:
  - adam.malone@acquia.com
  - james.gollan@acquia.com
  - paul.killer@gmail.com
  - sean.hamlin@acquia.com
  - stuart.rowlands@acquia.com
  slack:
    secure: jflE/Zs73rGpsnhN7qXqYDaVKyuwlNyQByMZrcwq2Cj7O84N3yp5x7fDbDTsJ4qYExBj3cnUXGzuS/SEtDWVdpwpjS4rcfL1uQvU4ZCuI6U9mI/KTWVGgD5+DkdS8/jZxsIfDtM8OYBwukqyaUCgGRzV609HR0NPiUofKnMxAPo=

before_install:
  - sudo apt-get update -qq
  - sudo apt-get install -y -qq postfix
  - composer selfupdate

install:
  - composer install --working-dir=build --prefer-source
  - export PATH=$PATH:$TRAVIS_BUILD_DIR/build/bin

before_script:
  # Create a mock mail system so Drupal install can send email somewhere.
  - sudo service postfix stop
  - smtp-sink -d "%d.%H.%M.%S" localhost:2500 1000 &
  - echo -e '#!/usr/bin/env bash\nexit 0' | sudo tee /usr/sbin/sendmail
  - echo 'sendmail_path = "/usr/sbin/sendmail -t -i "' | sudo tee "/home/travis/.phpenv/versions/`php -r 'echo PHP_VERSION;'`/etc/php.ini"

  # Install Apache
  - sudo apt-get install -y apache2 libapache2-mod-fastcgi
  - sudo cp ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf.default ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf
  - sudo a2enmod rewrite actions fastcgi alias
  - echo "cgi.fix_pathinfo = 1" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  - ~/.phpenv/versions/$(phpenv version-name)/sbin/php-fpm
  - sudo cp -f build/travis/travis-ci-apache /etc/apache2/sites-available/default
  - sudo sed -e "s?%TRAVIS_BUILD_DIR%?$(pwd)?g" --in-place /etc/apache2/sites-available/default
  - sudo service apache2 restart

  # Create Database
  - mysql -e 'CREATE DATABASE travis_ci_govcms_drupal;'

  # Build the codebase
  - phing -f build/phing/build.xml build:local

script:
  # Run tests
  - phing -f build/phing/build.xml run-tests

after_success:
  - phing -f build/phing/build.xml post-commit

